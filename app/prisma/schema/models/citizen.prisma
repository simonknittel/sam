/// Citizen
model Entity {
  id                                           String                               @id @default(cuid())
  createdAt                                    DateTime                             @default(now())
  updatedAt                                    DateTime                             @updatedAt
  logs                                         EntityLog[]
  createdById                                  String
  createdBy                                    User                                 @relation("createdBy", fields: [createdById], references: [id], onDelete: Cascade)
  activeOrganizationsMemberships               ActiveOrganizationMembership[]
  organizationMembershipHistoryEntries         OrganizationMembershipHistoryEntry[] @relation(name: "OrganizationMembershipHistoryEntry")
  createdOrganizationMemberHistoryEntries      OrganizationMembershipHistoryEntry[] @relation(name: "CreatedOrganizationMemberHistoryEntries")
  confirmedOrganizationMemberHistoryEntries    OrganizationMembershipHistoryEntry[] @relation(name: "ConfirmedOrganizationMemberHistoryEntries")
  createdOrganizationAttributeHistoryEntries   OrganizationAttributeHistoryEntry[]  @relation(name: "CreatedOrganizationAttributeHistoryEntries")
  confirmedOrganizationAttributeHistoryEntries OrganizationAttributeHistoryEntry[]  @relation(name: "ConfirmedOrganizationAttributeHistoryEntries")
  createdOrganizations                         Organization[]                       @relation(name: "CreatedOrganizations")
  receivedSilcTransactions                     SilcTransaction[]                    @relation("receiver")
  createdSilcTransactions                      SilcTransaction[]                    @relation("createdBy")
  updatedSilcTransactions                      SilcTransaction[]                    @relation("updatedBy")
  deletedSilcTransactions                      SilcTransaction[]                    @relation("deletedBy")
  updatedSilcSettings                          SilcSetting[]                        @relation("updatedBy")
  eventManagers                                Event[]                              @relation("eventManagers")
  createdTasks                                 Task[]                               @relation("createdBy")
  cancelledTasks                               Task[]                               @relation("cancelledBy")
  deletedTasks                                 Task[]                               @relation("deletedBy")
  assignedTasks                                TaskAssignment[]                     @relation("citizen")
  completedTasks                               Task[]                               @relation("completedBy")
  createdTaskAssignments                       TaskAssignment[]                     @relation("createdBy")
  completionistsTask                           Task[]                               @relation("completionists")
  participatedProfitDistributionCycles         ProfitDistributionCycleParticipant[] @relation("citizen")
  cededProfitDistributionCycles                ProfitDistributionCycleParticipant[] @relation("cededBy")
  acceptedProfitDistributionCycles             ProfitDistributionCycleParticipant[] @relation("acceptedBy")
  disbursedProfitDistributionCycles            ProfitDistributionCycleParticipant[] @relation("disbursedBy")
  createdProfitDistributionCycles              ProfitDistributionCycle[]            @relation("createdBy")
  collectionEndedProfitDistributionCycles      ProfitDistributionCycle[]            @relation("collectionEndedBy")
  payoutStartedProfitDistributionCycles        ProfitDistributionCycle[]            @relation("payoutStartedBy")
  payoutEndedProfitDistributionCycles          ProfitDistributionCycle[]            @relation("payoutEndedBy")
  notificationSettings                         NotificationSetting[]
  // receivedOnSiteNotifications                  OnSiteNotification[]
  webPushSubscriptions                         WebPushSubscription[]
  roleAssignments                              RoleAssignment[]                     @relation("citizen")
  /// Changes made by others to the roles of this citizen
  roleAssignmentChanges                        RoleAssignmentChange[]               @relation("citizen")
  /// Changes made by this citizen to the roles of other citizens
  createdRoleAssignmentChanges                 RoleAssignmentChange[]               @relation("createdBy")
  /// Changes made by others to the role level of this citizen
  // roleAssignmentLevelChanges                   RoleAssignmentLevelChange[]          @relation("citizen")
  /// Changes made by this citizen to the role level of other citizens
  // createdRoleAssignmentLevelChanges            RoleAssignmentLevelChange[]          @relation("createdBy")

  // Holds the latest confirmed values
  spectrumId                String?
  handle                    String?
  discordId                 String?                    @unique
  teamspeakId               String?
  citizenId                 String?
  communityMoniker          String?
  roles                     String?                    @db.Text // TODO: Delete after migrating to RoleAssignment
  createdPenaltyEntries     PenaltyEntry[]             @relation("createdBy")
  deletedPenaltyEntries     PenaltyEntry[]             @relation("deletedBy")
  penaltyEntries            PenaltyEntry[]             @relation("citizen")
  eventPositionApplications EventPositionApplication[] @relation("citizen")
  eventPositions            EventPosition[]            @relation("citizen")
  silcBalance               Int                        @default(0)
  totalEarnedSilc           Int                        @default(0)

  @@index([roles])
}

model EntityLog {
  id            String               @id @default(cuid())
  entityId      String
  entity        Entity               @relation(fields: [entityId], references: [id], onDelete: Cascade)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  type          String // TODO: types.ts
  content       String?              @db.Text
  submittedById String?
  submittedBy   User?                @relation("submittedBy", fields: [submittedById], references: [id], onDelete: Cascade)
  attributes    EntityLogAttribute[]

  @@index([type]) // `type: Hash` isn't supported on MySQL
}

model EntityLogAttribute {
  id          String    @id @default(cuid())
  entityLogId String    @map("eneityLogId")
  entityLog   EntityLog @relation(fields: [entityLogId], references: [id], onDelete: Cascade)
  key         String // TODO: types.ts
  value       String
  createdAt   DateTime  @default(now())
  createdById String?
  createdBy   User?     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([key]) // `type: Hash` isn't supported on MySQL
}

/// Materialized/denormalized view of currently assigned roles to citizens.
/// This model is derived from the change history in `RoleAssignmentChange` and
/// `RoleAssignmentLevelChange`. Fields like `currentLevel` and
/// `currentLevelUpdatedAt` require aggregation logic. Synchronization of this
/// table with change history is handled by application logic.
model RoleAssignment {
  id        String   @id @default(cuid(2))
  citizenId String
  citizen   Entity   @relation("citizen", fields: [citizenId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation("role", fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  /// The current level of the citizen for this role. NULL if the role does not
  /// have levels. The citizen receives the permissions of this role only when
  /// their currentLevel equals the maximum level defined in Role.maxLevel.
  /// This be handled by application logic.
  // currentLevel          Int?
  /// Last time the current level was updated. NULL if the role does not have
  /// levels.
  // currentLevelUpdatedAt DateTime?

  @@unique([citizenId, roleId])
}

enum RoleAssignmentChangeType {
  ADD
  REMOVE
}

/// History of changes to a citizen's roles
model RoleAssignmentChange {
  id          String                   @id @default(cuid(2))
  citizenId   String
  citizen     Entity                   @relation("citizen", fields: [citizenId], references: [id], onDelete: Cascade)
  roleId      String
  role        Role                     @relation("role", fields: [roleId], references: [id], onDelete: Cascade)
  type        RoleAssignmentChangeType
  createdAt   DateTime                 @default(now())
  createdById String?
  createdBy   Entity?                  @relation("createdBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([citizenId])
}

// enum RoleAssignmentLevelChangeType {
//   UP
//   DOWN
// }

// model RoleAssignmentLevelChange {
//   id          String                        @id @default(cuid(2))
//   citizenId   String
//   citizen     Entity                        @relation("citizen", fields: [citizenId], references: [id], onDelete: Cascade)
//   roleId      String
//   role        Role                          @relation("role", fields: [roleId], references: [id], onDelete: Cascade)
//   type        RoleAssignmentLevelChangeType
//   createdAt   DateTime                      @default(now())
//   createdById String?
//   createdBy   Entity?                       @relation("createdBy", fields: [createdById], references: [id], onDelete: SetNull)

//   @@index([citizenId])
// }
