name: Production release notification

on:
  deployment_status:

jobs:
  notify_soketi:
    name: Notify Soketi
    if: >-
      github.event.deployment.environment == 'Production' &&
      github.event.deployment_status.state == 'success'
    runs-on: ubuntu-24.04
    environment: Production
    steps:
      - name: Send release event
        env:
          HOST: ${{ vars.SOKETI_HOST }}
          APP_ID: ${{ vars.SOKETI_APP_ID }}
          APP_KEY: ${{ vars.SOKETI_APP_KEY }}
          APP_SECRET: ${{ secrets.SOKETI_APP_SECRET }}
        shell: bash
        run: |
          set -euo pipefail

          for var in HOST APP_ID APP_KEY APP_SECRET; do
            if [ -z "${!var:-}" ]; then
              echo "Missing required environment variable: $var" >&2
              exit 1
            fi
          done

          BODY='{"name":"new","channels":["releases"],"data":"{}"}'
          BODY_MD5=$(printf '%s' "$BODY" | md5sum | awk '{print $1}')
          TIMESTAMP=$(date -u +%s)

          QUERY_BASE="auth_key=${APP_KEY}&auth_timestamp=${TIMESTAMP}&auth_version=1.0&body_md5=${BODY_MD5}"
          STRING_TO_SIGN=$'POST\n/apps/'"${APP_ID}"$'/events\n'"${QUERY_BASE}"
          SIGNATURE=$(printf '%s' "$STRING_TO_SIGN" | openssl dgst -sha256 -hmac "$APP_SECRET" -binary | xxd -p -c 256)

          curl -X POST "${HOST}/apps/${APP_ID}/events?${QUERY_BASE}&auth_signature=${SIGNATURE}" \
            -H "Content-Type: application/json" \
            -d "$BODY"

  smoke_test:
    name: Playwright tests
    if: >-
      github.event.deployment.environment == 'Production' &&
      github.event.deployment_status.state == 'success'
    runs-on: ubuntu-24.04
    environment: Production
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-noble
      options: --user 1001
    defaults:
      run:
        working-directory: pnpm-monorepo
    steps:
      - uses: actions/checkout@v5.0.1

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.28.2

      - uses: actions/setup-node@v6.2.0
        with:
          node-version-file: pnpm-monorepo/.nvmrc
          cache: pnpm
          cache-dependency-path: pnpm-monorepo/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --filter @sam-monorepo/playwright
        working-directory: pnpm-monorepo

      - name: Run tests
        run: pnpm --filter @sam-monorepo/playwright test
        working-directory: pnpm-monorepo
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ vars.PRODUCTION_URL }}

      - name: Upload test report
        uses: actions/upload-artifact@v4.6.2
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: pnpm-monorepo/apps/playwright/playwright-report/
          retention-days: 7
