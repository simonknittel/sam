name: Playwright tests

on:
  deployment_status:
  schedule:
    - cron: '0 0,8,16 * * *'
  workflow_dispatch:

jobs:
  smoke_test:
    name: Playwright tests
    if: >-
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event.deployment.environment == 'Production' &&
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.creator.login == 'vercel[bot]' &&
      github.event.deployment_status.environment_url)
    runs-on: ubuntu-24.04
    environment: Production
    permissions:
      contents: read
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
      options: --user 1001
    defaults:
      run:
        working-directory: pnpm-monorepo
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.28.2

      - uses: actions/setup-node@v6.2.0
        with:
          node-version-file: pnpm-monorepo/.nvmrc
          cache: pnpm
          cache-dependency-path: pnpm-monorepo/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --filter @sam-monorepo/playwright

      - name: Run tests
        run: pnpm --filter @sam-monorepo/playwright test
        env:
          BASE_URL: ${{ vars.BASE_URL }}
          PLAYWRIGHT_CUSTOM_HEADER_NAME: ${{ vars.PLAYWRIGHT_CUSTOM_HEADER_NAME }}
          PLAYWRIGHT_CUSTOM_HEADER_VALUE: ${{ secrets.PLAYWRIGHT_CUSTOM_HEADER_VALUE }}

      - name: Upload test report
        uses: actions/upload-artifact@v6.0.0
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: pnpm-monorepo/apps/playwright/playwright-report/
          retention-days: 7
